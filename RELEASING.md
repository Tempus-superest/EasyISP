# Releasing EasyISP

## Summary

- Merging a PR into `main` runs `.github/workflows/release.yml`, which reads `EasyISP.version`, ensures the tag is new, validates the `DOWNLOAD` field, creates the GitHub Release in the visibility defined by the `RELEASE_MODE` repository variable (`draft` when unset/default, `publish` when set to `publish`), builds the manifest-driven ZIP, and uploads it to the release in the same workflow run.

## Release Inputs

- `EasyISP.version`: single source of truth for the version number (`VERSION.MAJOR`, `VERSION.MINOR`, `VERSION.PATCH`) and the `DOWNLOAD` URL that must match `https://github.com/Tempus-superest/EasyISP/releases/tag/vX.Y.Z`.
- `release-manifest.txt`: lists the repository paths that must be copied into `GameData/EasyISP/` before zipping; the packaging script fails if any path is missing.

## Release Flow

1. A PR merges into `main`.
2. `.github/scripts/get-version.sh` parses `EasyISP.version` to produce `VERSION` and `TAG` (`vX.Y.Z`).
3. The release workflow fetches tags and exits if `TAG` already exists.
4. The workflow validates `DOWNLOAD` matches the expected release URL.
5. `gh release create` is invoked with `--draft` when `RELEASE_MODE` is unset or `draft`, and without it when `RELEASE_MODE=publish`; this also creates the `vX.Y.Z` tag.
6. The workflow runs `.github/scripts/package.sh` to copy files from `release-manifest.txt` into `dist/GameData/EasyISP/` and builds `EasyISP-vX.Y.Z.zip` containing only `GameData/...`.
7. The workflow uploads the ZIP to the GitHub Release matching the tag.
8. SpaceDock and CKAN ingestion happen outside this automation (out of scope).

## Automation Rules

### Release mode configuration

- The repository variable `RELEASE_MODE` (`vars.RELEASE_MODE`) controls release visibility. The workflows treat an empty value as `draft`, accept only `draft` or `publish`, and abort immediately on other values.

### Idempotency and validation

- Fresh tags are enforced by fetching the full tag history (`fetch-depth: 0`).
- Packaging wipes `dist/GameData/EasyISP/` before staging the manifest contents, so every build starts clean.
- The release workflow checks `DOWNLOAD`, validates the tag is new, and ensures all manifest entries exist via the packaging script.
- The workflows invoke scripts under `.github/scripts/` directly, so those files must stay executable in git.
- `gh release upload` runs without overwriting assets; reruns must delete the existing asset first so failures surface.

### Failure handling

- A missing manifest entry, mismatched tag/version, invalid `RELEASE_MODE`, or failed `gh release upload` stops the workflow with a descriptive error so maintainers can fix the root cause before retrying.

## Documentation

- `.github/scripts/get-version.sh`: extracts `VERSION` and `TAG` from `EasyISP.version` and emits them for workflows.
- `.github/scripts/package.sh`: validates the manifest, stages files under `dist/GameData/EasyISP/`, and produces `EasyISP-vX.Y.Z.zip`.
- `.github/workflows/release.yml`: validates metadata, honors `RELEASE_MODE`, creates the GitHub Release with autogenerated notes, builds `EasyISP-vX.Y.Z.zip`, and uploads it as the release asset without overwriting existing uploads.
