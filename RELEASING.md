# Releasing EasyISP

## Summary

- Merging a PR into `main` runs `.github/workflows/release.yml`, which reads `EasyISP.version`, ensures the tag is new, validates the `DOWNLOAD` field, and uses `gh release create` to build the GitHub Release in the visibility defined by the `RELEASE_MODE` repository variable (`draft` when unset/default, `publish` when set to `publish`).
- Pushing a tag named `vX.Y.Z` runs `.github/workflows/package.yml`, which packages the manifest files into `EasyISP-vX.Y.Z.zip` and uploads it to the matching release.

## Release Inputs

- `EasyISP.version`: single source of truth for the version number (`VERSION.MAJOR/MINOR/PATCH`) and the `DOWNLOAD` URL that must match `https://github.com/Tempus-superest/EasyISP/releases/tag/vX.Y.Z`.
- `release-manifest.txt`: lists the repository paths that must be copied into `GameData/EasyISP/` before zipping; the packaging script fails if any path is missing.

## Release Flow

1. A PR merges into `main`.
2. `.github/scripts/get-version.sh` parses `EasyISP.version` to produce `VERSION` and `TAG` (`vX.Y.Z`).
3. The release workflow fetches tags and exits if `TAG` already exists.
4. The workflow validates `DOWNLOAD` matches the expected release URL.
5. An annotated tag `vX.Y.Z` is created and pushed.
6. `gh release create` is invoked with `--draft` when `RELEASE_MODE` is unset or `draft`, and without it when `RELEASE_MODE=publish`.
7. Pushing `vX.Y.Z` runs the packaging workflow: it ensures `github.ref_name` equals `TAG`, copies files from `release-manifest.txt` into `dist/GameData/EasyISP/`, and builds `EasyISP-vX.Y.Z.zip` containing only `GameData/...`.
8. The packaging workflow uploads the ZIP to the GitHub Release matching the tag.
9. SpaceDock and CKAN ingestion happen outside this automation (out of scope).

## Automation Rules

### Release mode configuration

- The repository variable `RELEASE_MODE` (`vars.RELEASE_MODE`) controls release visibility. The workflows treat an empty value as `draft`, accept only `draft` or `publish`, and abort immediately on other values.

### Idempotency and validation

- Fresh tags are enforced by fetching the full tag history (`fetch-depth: 0`).
- Packaging wipes `dist/GameData/EasyISP/` before staging the manifest contents, so every build starts clean.
- Release workflow checks `DOWNLOAD` and tag equality; packaging workflow enforces `github.ref_name` equals the parsed tag and that all manifest entries exist.

### Failure handling

- A missing manifest entry, mismatched tag/version, invalid `RELEASE_MODE`, or failed `gh release upload` stops the workflow with a descriptive error so maintainers can fix the root cause before retrying.

## Documentation

- `.github/scripts/get-version.sh`: extracts `VERSION` and `TAG` from `EasyISP.version` and emits them for workflows.
- `.github/scripts/package.sh`: validates the manifest, stages files under `dist/GameData/EasyISP/`, and produces `EasyISP-vX.Y.Z.zip`.
- `.github/workflows/release.yml`: tags `main`, validates metadata, honors `RELEASE_MODE`, and creates the GitHub Release with autogenerated notes.
- `.github/workflows/package.yml`: runs on `v*` tags, checks tag alignment, builds the ZIP, and uploads it as the release asset without overwriting existing uploads.
