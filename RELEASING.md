# Releasing EasyISP

## Summary

EasyISP release automation has two workflows:

- `.github/workflows/release.yml` runs on every push to `main`. It determines `vX.Y.Z` from `EasyISP.version`, validates metadata, builds `EasyISP-vX.Y.Z.zip`, creates/updates the matching GitHub Release, and uploads the ZIP asset.
- `.github/workflows/spacedock.yml` runs only on `release: published`. It downloads the GitHub release ZIP and publishes it to SpaceDock via a vendored local action at `.github/actions/spacedock-upload`.

## Required Version Consistency

For every version bump, all of the following must stay aligned:

- `EasyISP.version` `VERSION` fields (`MAJOR`, `MINOR`, `PATCH`) -> `X.Y.Z`
- Git tag -> `vX.Y.Z`
- GitHub Release tag -> `vX.Y.Z`
- `EasyISP.version` `DOWNLOAD` -> `https://github.com/Tempus-superest/EasyISP/releases/tag/vX.Y.Z`
- `README.md` current version link text -> `vX.Y.Z`

## Release Inputs

- `EasyISP.version`: source of truth for version and `DOWNLOAD` URL.
- `release-manifest.txt`: list of repository paths copied into `GameData/EasyISP/` before zipping.
- `vars.RELEASE_MODE`: optional; valid values are `draft` or `publish`. Default behavior is `draft` when unset.

## Workflow: GitHub Release (`release.yml`)

Trigger:

- Push to `main`

Process:

1. Checkout with full history (`fetch-depth: 0`).
2. Run `.github/scripts/get-version.sh` to emit:
   - `VERSION=X.Y.Z`
   - `TAG=vX.Y.Z`
3. Fetch tags and check whether `TAG` already exists.
4. If the tag already exists, require that a GitHub Release for that tag already exists (retry safety check).
5. Validate `EasyISP.version` `DOWNLOAD` exactly matches `https://github.com/Tempus-superest/EasyISP/releases/tag/vX.Y.Z`.
6. Run `.github/scripts/package.sh --version X.Y.Z` to build `EasyISP-vX.Y.Z.zip` from `release-manifest.txt`.
7. If the tag does not exist:
   - create lightweight tag locally,
   - push the tag,
   - create a draft GitHub Release with autogenerated notes.
8. Upload `EasyISP-vX.Y.Z.zip` to the release using `gh release upload`.
9. If `RELEASE_MODE=publish`, publish the release (`gh release edit --draft=false`).

Notes:

- The release is always created as draft first, then optionally published.
- Asset upload happens before publication so downstream consumers only see complete published releases.

## Workflow: SpaceDock Publish (`spacedock.yml`)

Trigger:

- `release` event with type `published`

Process:

1. Download `EasyISP-vX.Y.Z.zip` from the published GitHub Release tag.
2. Run local action `./.github/actions/spacedock-upload` with:
   - SpaceDock credentials (`SPACEDOCK_USERNAME`, `SPACEDOCK_PASSWORD`)
   - mod/game IDs (`SPACEDOCK_MOD_ID`, `SPACEDOCK_GAME_ID`)
   - Git tag version (`vX.Y.Z`)
   - downloaded ZIP path as `zipball`
   - changelog content from `github.event.release.body`
   - `spacedock_website: spacedock.info`
3. The local action handles login/upload and fails the job on SpaceDock auth/API errors.

### Why the action is vendored

- Upstream action repository: https://github.com/KSP2Community/spacedock-upload
- Upstream issue showing auth breakage from unquoted secret expansion: https://github.com/KSP2Community/spacedock-upload/issues/2
- EasyISP previously pinned upstream `v1.0.1`, then vendored and patched locally for literal-safe password handling.
- Vendored login sends username/password as literal multipart form strings and does not URL-encode password for `/api/login`.
- Do not switch back to upstream in the workflow until an upstream fix is released and verified with special-character secrets.

## SpaceDock Configuration

Required GitHub secrets:

- `secrets.SPACEDOCK_USERNAME`
- `secrets.SPACEDOCK_PASSWORD`

Required/optional GitHub variables:

- `vars.SPACEDOCK_MOD_ID` (required)
- `vars.SPACEDOCK_GAME_ID` (optional in workflow; defaults to `3102` when unset)

## Script Responsibilities

- `.github/scripts/get-version.sh`
  - Parses `EasyISP.version` JSON.
  - Validates `VERSION.MAJOR|MINOR|PATCH` as non-negative integers.
  - Emits `VERSION` and `TAG`.

- `.github/scripts/package.sh`
  - Validates and reads `release-manifest.txt`.
  - Stages files into `dist/GameData/EasyISP/`.
  - Produces `EasyISP-vX.Y.Z.zip` in repo root.

## Failure Handling

- Release workflow fails fast on:
  - invalid/missing version metadata,
  - `DOWNLOAD` mismatch,
  - missing manifest entries,
  - invalid `RELEASE_MODE`,
  - missing ZIP or upload errors.

- SpaceDock workflow fails fast on:
  - missing required SpaceDock secrets/vars,
  - release asset download failures,
  - SpaceDock action upload/auth/API failures.

## Operational Notes

- Keep executable bit on scripts under `.github/scripts/`.
- `gh release upload` does not overwrite existing assets; if rerunning and the asset already exists, remove it first.
- CKAN ingestion remains external to this repository's automation.
