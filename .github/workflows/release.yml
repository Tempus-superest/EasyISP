name: Release Automation

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      RELEASE_MODE: ${{ vars.RELEASE_MODE }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: bash .github/scripts/get-version.sh

      - name: Fetch tags
        run: git fetch --tags

      - name: Check for existing tag/release
        id: tag_check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Allow retries when packaging/upload fails after tag creation.
          tag="${{ steps.version.outputs.TAG }}"
          if git rev-parse --verify "refs/tags/$tag" >/dev/null 2>&1; then
            echo "Tag $tag already exists; verifying release is present for retry."
            if ! gh release view "$tag" >/dev/null 2>&1; then
              echo "Tag $tag exists but no GitHub release found." >&2
              exit 1
            fi
            echo "tag_exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "tag_exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Validate DOWNLOAD URL
        run: |
          # Enforce that EasyISP.version points at the exact release tag URL.
          tag="${{ steps.version.outputs.TAG }}"
          python3 - "$tag" <<'PY'
          import json
          import pathlib
          import sys

          path = pathlib.Path("EasyISP.version")
          try:
              data = json.loads(path.read_text())
          except Exception as exc:
              raise SystemExit(f"Error reading EasyISP.version: {exc}")

          download = data.get("DOWNLOAD")
          if not isinstance(download, str):
              raise SystemExit("Error: DOWNLOAD field missing or invalid in EasyISP.version")
          expected = f"https://github.com/Tempus-superest/EasyISP/releases/tag/{sys.argv[1]}"
          if download != expected:
              raise SystemExit(f"DOWNLOAD must equal {expected}, got {download}")
          print("DOWNLOAD field matches expected release tag")
          PY

      - name: Package manifest files
        run: |
          # Build the canonical ZIP from the manifest to ensure GameData/EasyISP layout.
          bash .github/scripts/package.sh --version "${{ steps.version.outputs.VERSION }}"

      - name: Create and push tag
        if: steps.tag_check.outputs.tag_exists != 'true'
        run: |
          # Create a lightweight tag locally so the release references a real pushed tag.
          tag="${{ steps.version.outputs.TAG }}"
          # Ensure the tag is created only once on the release automation path.
          git tag "$tag"
          # Push the tag before creating the GitHub release to avoid untagged URLs.
          git push origin "$tag"

      - name: Create GitHub release
        if: steps.tag_check.outputs.tag_exists != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create the release for the already-pushed tag so the URL resolves to the tag.
          tag="${{ steps.version.outputs.TAG }}"
          # Normalize the release mode to draft by default to match existing automation behavior.
          mode="${RELEASE_MODE:-draft}"
          # Validate the release mode so automation fails fast on unexpected values.
          if [[ "$mode" != "draft" && "$mode" != "publish" ]]; then
            echo "Invalid RELEASE_MODE '$mode'; allowed values are 'draft' or 'publish'" >&2
            exit 1
          fi
          # Build the release creation command with auto-generated notes.
          args=(gh release create "$tag" --generate-notes)
          # Add the draft flag when the release mode indicates a draft release.
          if [[ "$mode" == "draft" ]]; then
            args+=(--draft)
          fi
          # Log the release intent for traceability in the workflow output.
          echo "Creating $mode release for $tag"
          # Execute the GitHub release creation against the pushed tag.
          "${args[@]}"

      - name: Upload zip to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Upload the asset to the release without overwriting existing files.
          tag="${{ steps.version.outputs.TAG }}"
          asset="EasyISP-v${{ steps.version.outputs.VERSION }}.zip"
          asset_path="$GITHUB_WORKSPACE/$asset"
          if [[ ! -f "$asset_path" ]]; then
            echo "Expected artifact $asset_path not found" >&2
            exit 1
          fi
          gh release upload "$tag" "$asset_path"

      - name: Confirm upload
        run: |
          # Confirm the asset name and tag for release logs.
          echo "Uploaded EasyISP-v${{ steps.version.outputs.VERSION }}.zip to release ${{ steps.version.outputs.TAG }}"
